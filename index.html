<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genetic Rogue Ver.0.11.2 - Fixed</title>
    <!-- Favicon Fix: Use Emoji as Icon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ§¬</text></svg>">
    <style>
        :root {
            --bg-color: #050505; --panel-bg: #111; --text-color: #ccc;
            --accent-color: #00ff9d; --danger-color: #ff4d4d; --warn-color: #ff9900; --info-color: #3498db;
            --tier1: #bdc3c7; --tier2: #3498db; --tier3: #9b59b6; --tier4: #e74c3c; --tier5: #f1c40f;
            --rar-bad: #7f8c8d; --rar-common: #ccc; --rar-good: #2ecc71; --rar-rare: #3498db; --rar-legend: #f1c40f; --rar-god: #e056fd;
            --elem-fire: #e74c3c; --elem-water: #3498db; --elem-wind: #2ecc71; --elem-earth: #d35400; --elem-light: #f1c40f; --elem-dark: #9b59b6;
            --log-font: 'Helvetica Neue', Arial, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { background: var(--bg-color); color: var(--text-color); font-family: var(--log-font); height: 100vh; display: flex; flex-direction: column; }
        
        /* Layout */
        #app { display: grid; grid-template-rows: 50px 1fr 60px; height: 100%; max-width: 1400px; margin: 0 auto; width: 100%; }
        header { background: var(--panel-bg); border-bottom: 1px solid #333; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; }
        main { display: grid; grid-template-columns: 350px 1fr; gap: 1px; background: #222; overflow: hidden; }
        @media (max-width: 800px) { main { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; } }

        /* Logs */
        #log-panel { background: var(--bg-color); padding: 10px; overflow-y: auto; font-size: 12px; line-height: 1.5; }
        .log-entry { margin-bottom: 3px; padding-left: 5px; border-left: 2px solid #333; }
        .log-combat { color: #888; border-color: #444; }
        .log-dmg { color: #aaa; }
        .log-victory { color: #fff; border-color: var(--accent-color); }
        .log-item { color: var(--rar-rare); border-color: var(--rar-rare); }
        .log-equip { color: var(--info-color); border-color: var(--info-color); }
        .log-defeat { color: var(--danger-color); border-color: var(--danger-color); font-weight: bold; }
        .log-elite { color: var(--warn-color); border-color: var(--warn-color); }
        .log-trap { color: var(--warn-color); border-color: var(--danger-color); }
        .log-skill { color: var(--info-color); border-color: var(--info-color); }
        .log-sys { color: #888; border-color: #888; font-style: italic; }
        .log-err { color: var(--danger-color); border-color: var(--danger-color); }
        .log-lvlup { color: #e67e22; border-color: #e67e22; font-weight: bold; }

        /* Party Cards */
        #party-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 8px; padding: 10px; overflow-y: auto; }
        .char-card { background: #1a1a1a; border: 1px solid #333; padding: 10px; border-radius: 4px; font-size: 11px; position: relative; transition: all 0.2s; cursor: pointer; }
        .char-card:hover { border-color: #666; background: #222; transform: translateY(-2px); }
        .char-card.dead { opacity: 0.6; filter: grayscale(100%); border-color: #333 !important; cursor: not-allowed; }
        .char-card.dead::after { content: "æˆ¦é—˜ä¸èƒ½"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--danger-color); font-weight: bold; font-size: 20px; border: 2px solid var(--danger-color); padding: 5px 10px; transform: rotate(-10deg); }
        
        .char-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 4px; align-items: center; }
        .job-label { font-size: 10px; padding: 1px 4px; border-radius: 3px; background: #333; color: #fff; }
        .personality-label { color: var(--warn-color); margin-right: 5px; font-size: 10px; }
        
        /* Bars */
        .bar-container { display: flex; flex-direction: column; gap: 2px; margin: 5px 0; }
        .bar-row { display: flex; align-items: center; gap: 5px; font-size: 9px; color: #888; }
        .bar-wrap { flex: 1; background: #333; height: 6px; border-radius: 3px; overflow: hidden; position: relative; }
        .bar-val { height: 100%; transition: width 0.3s; }
        .hp-bar { background: var(--accent-color); }
        .exp-bar { background: #3498db; }
        
        /* Elements */
        .elem-icon { display:inline-block; width:12px; height:12px; border-radius:50%; margin-right:2px; vertical-align:middle; position: relative; top: -1px; }
        .el-fire { background: var(--elem-fire); box-shadow: 0 0 4px var(--elem-fire); }
        .el-water { background: var(--elem-water); box-shadow: 0 0 4px var(--elem-water); }
        .el-wind { background: var(--elem-wind); box-shadow: 0 0 4px var(--elem-wind); }
        .el-earth { background: var(--elem-earth); box-shadow: 0 0 4px var(--elem-earth); }
        .el-light { background: var(--elem-light); box-shadow: 0 0 4px var(--elem-light); }
        .el-dark { background: var(--elem-dark); box-shadow: 0 0 4px var(--elem-dark); }

        /* Stats & Equip */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 4px; color: #aaa; margin-top: 6px; }
        .stat-val span { color: #fff; }
        .stat-bonus { color: var(--accent-color); }
        
        .equip-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; margin-top: 8px; border-top: 1px solid #333; padding-top: 6px; }
        .equip-slot { background: #111; padding: 4px; border-radius: 2px; color: #666; font-size: 10px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; cursor: help; }
        .equip-active { color: #ddd; border: 1px solid #333; }
        
        /* Skills */
        .skill-list { display: flex; flex-wrap: wrap; gap: 2px; margin-top: 5px; }
        .skill-tag { background: #002233; color: #3498db; padding: 1px 4px; font-size: 9px; border-radius: 2px; border: 1px solid #004466; }

        /* Rarity Colors */
        .rar-1 { color: var(--rar-bad); } .rar-2 { color: var(--rar-common); } .rar-3 { color: var(--rar-good); } 
        .rar-4 { color: var(--rar-rare); } .rar-5 { color: var(--rar-legend); text-shadow: 0 0 2px rgba(241, 196, 15, 0.5); }
        .rar-6 { color: var(--rar-god); text-shadow: 0 0 3px rgba(224, 86, 253, 0.6); }

        /* Footer & Modals */
        footer { background: var(--panel-bg); border-top: 1px solid #333; display: flex; align-items: center; justify-content: center; gap: 10px; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 8px 16px; cursor: pointer; border-radius: 3px; font-size: 12px; transition: all 0.2s; }
        button:hover:not(:disabled) { background: #444; border-color: #777; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        button.primary { background: #004433; border-color: var(--accent-color); color: var(--accent-color); }
        button.danger { border-color: var(--danger-color); color: var(--danger-color); }
        
        /* Fixed: Button visibility */
        button.icon-btn { 
            font-size: 16px; padding: 5px 12px; border: 1px solid #444; 
            background: #222; color: #eee; border-radius: 4px; cursor: pointer; 
        }
        button.icon-btn:hover { background: #333; border-color: #777; }
        
        .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.85); display: none; z-index: 99; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-box { background: #111; width: 95%; max-width: 1000px; max-height: 90vh; border: 1px solid #444; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        .modal-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        
        .grid-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
        .list-item { padding: 10px; border: 1px solid #333; cursor: pointer; background: #161616; transition: border-color 0.2s; position: relative; }
        .list-item:hover { border-color: #666; background: #1f1f1f; }
        .list-item.selected { border-color: var(--accent-color); background: #002211; }
        .list-item.disabled { opacity: 0.4; cursor: not-allowed; background: #222; }
        .err-msg { color: var(--danger-color); font-size: 10px; display: block; margin-top: 2px; }
        
        .tab-group { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: transparent; border: none; color: #666; cursor: pointer; font-weight: bold; padding: 5px 10px; }
        .tab-btn.active { color: var(--accent-color); border-bottom: 2px solid var(--accent-color); }
        
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #222; }

        /* Detail Modal */
        .detail-header { display: flex; gap: 20px; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 15px; }
        .detail-title h2 { margin: 0; font-size: 24px; color: #fff; }
        .detail-meta { color: #888; font-size: 12px; }
        .detail-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 600px) { .detail-sections { grid-template-columns: 1fr; } }
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 8px 0; font-size: 13px; }
        .detail-row span:last-child { color: #fff; font-weight: bold; }
        .detail-label { color: #888; }
        .detail-eq-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: #1a1a1a; margin-bottom: 5px; border-radius: 4px; }
        
        /* Rule Book */
        .rule-section { margin-bottom: 20px; }
        .rule-section h4 { color: var(--accent-color); margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .rule-section p, .rule-section li { color: #ccc; font-size: 13px; line-height: 1.6; }
        .rule-table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 5px; }
        .rule-table th, .rule-table td { border: 1px solid #444; padding: 5px; text-align: left; }
    </style>
</head>
<body>

<div id="app">
    <header>
        <div>ğŸ§¬ Genetic Rogue <span style="color:#666;">Ver.11.2</span></div>
        <div style="font-size:14px; display:flex; align-items:center; gap:10px;">
            <div>
                <span style="color:#aaa;">éšå±¤:</span> <span id="floor-display" style="font-weight:bold; font-size:16px;">1</span>
                <span id="floor-progress" style="color:#666; font-size:12px; margin-left:5px;">(0/30)</span>
                <span style="color:#666; font-size:12px;">(æœ€æ·±: <span id="max-floor">1</span>)</span>
            </div>
            <div style="font-weight:bold; color:var(--accent-color); margin-right:10px;">Helix: <span id="helix-display">0</span></div>
            <button class="icon-btn" id="btn-help">â“ãƒ«ãƒ¼ãƒ«</button>
            <button class="icon-btn" id="btn-settings">âš™ï¸è¨­å®š</button>
        </div>
    </header>

    <main>
        <div id="log-panel"><div id="log-list"></div></div>
        <div id="info-panel">
            <div id="party-container"></div>
        </div>
    </main>

    <footer>
        <div style="display:flex; align-items:center; gap:5px; margin-right:10px;">
            <span style="font-size:11px; color:#888;">é–‹å§‹éšå±¤:</span>
            <select id="floor-select" style="background:#222; color:#fff; border:1px solid #444; padding:5px; border-radius:3px;">
                <option value="1">1F</option>
            </select>
        </div>
        <button id="btn-explore" class="primary">æ¢ç´¢é–‹å§‹</button>
        <button id="btn-return" disabled>å¸°é‚„</button>
        <span style="width:20px"></span>
        <button id="btn-lab">ãƒ©ãƒœ / ã‚®ãƒ«ãƒ‰</button>
        <button id="btn-inv">è£…å‚™</button>
    </footer>
</div>

<!-- Modal: Lab & Guild -->
<div id="modal-lab" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>éºä¼å­ãƒ©ãƒœ & ã‚®ãƒ«ãƒ‰</h3> <button class="close-modal">é–‰ã˜ã‚‹</button>
        </div>
        <div class="modal-body">
            <div class="tab-group">
                <button class="tab-btn active" onclick="UI.switchTab('lab-roster')">ç·¨æˆãƒªã‚¹ãƒˆ</button>
                <button class="tab-btn" onclick="UI.switchTab('lab-hire')">é›‡ç”¨ (Guild)</button>
                <button class="tab-btn" onclick="UI.switchTab('lab-class')">è»¢è· (Class Change)</button>
            </div>
            
            <div id="tab-lab-roster" class="tab-content">
                <div style="margin-bottom:10px; display:flex; gap:10px; align-items:center;">
                    <button id="act-breed" disabled>é…åˆ</button>
                    <button id="act-party" disabled>PTç·¨æˆ/è§£é™¤</button>
                    <span id="breed-info" style="font-size:11px; color:#888;">â€»é…åˆæ¡ä»¶: ä¸¡è¦ªLv30ä»¥ä¸Š</span>
                </div>
                <div id="lab-list" class="grid-list"></div>
            </div>

            <div id="tab-lab-hire" class="tab-content" style="display:none;">
                <p style="color:#888; margin-bottom:10px;">é›‡ç”¨ã‚³ã‚¹ãƒˆ: <span id="hire-cost">30</span> Helix</p>
                <div id="guild-list" class="grid-list"></div>
            </div>

            <div id="tab-lab-class" class="tab-content" style="display:none;">
                <div style="display:flex; gap:20px; height:100%;">
                    <div style="width:250px; border-right:1px solid #333;">
                        <h4>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h4>
                        <div id="cc-char-list" style="display:flex; flex-direction:column; gap:5px; margin-top:10px;"></div>
                    </div>
                    <div style="flex:1;">
                        <h4>è»¢è·å…ˆã‚¯ãƒ©ã‚¹</h4>
                        <p style="font-size:12px; color:#888; margin-bottom:10px;">æ¡ä»¶: Lv10ä»¥ä¸Š, ã‚³ã‚¹ãƒˆ: 100G. ä¸€éƒ¨è·æ¥­ã¯å±æ€§å¿…é ˆã€‚</p>
                        <div id="cc-job-list" class="grid-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Inventory -->
<div id="modal-inv" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>è£…å‚™ç®¡ç†</h3> <button class="close-modal">é–‰ã˜ã‚‹</button>
        </div>
        <div class="modal-body" style="display:flex; gap:20px;">
            <div style="width:250px; border-right:1px solid #333; padding-right:10px;">
                <h4 style="margin-bottom:10px;">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ</h4>
                <div id="equip-char-list"></div>
            </div>
            <div style="flex:1;">
                <div id="inv-header" style="margin-bottom:10px; border-bottom:1px solid #333; padding-bottom:10px;"></div>
                <div id="inv-list" class="grid-list"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Settings -->
<div id="modal-settings" class="modal-overlay">
    <div class="modal-box" style="max-width:500px;">
        <div class="modal-header">
            <h3>è¨­å®š (Settings)</h3> <button class="close-modal">é–‰ã˜ã‚‹</button>
        </div>
        <div class="modal-body">
            <div class="settings-row">
                <span>ãƒ‡ãƒ¼ã‚¿ã‚»ãƒ¼ãƒ– (æ‰‹å‹•)</span>
                <button onclick="Game.save(true)">ã‚»ãƒ¼ãƒ–å®Ÿè¡Œ</button>
            </div>
            <div class="settings-row">
                <span>ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰</span>
                <button onclick="location.reload()">ãƒªãƒ­ãƒ¼ãƒ‰ (å†èª­è¾¼)</button>
            </div>
            <div class="settings-row">
                <span>è‡ªå‹•ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½</span>
                <span style="color:var(--accent-color); font-weight:bold;">ON (æœ‰åŠ¹)</span>
            </div>
            <div class="settings-row" style="border-bottom:none; margin-top:20px;">
                <span style="color:var(--danger-color);">ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</span>
                <button class="danger" onclick="Game.resetSave()">å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
            </div>
            <p style="font-size:11px; color:#666; margin-top:10px;">â€»æ¢ç´¢çµ‚äº†æ™‚ã€é…åˆæ™‚ã€è»¢è·æ™‚ã€é›‡ç”¨æ™‚ã«è‡ªå‹•ã§ã‚»ãƒ¼ãƒ–ã•ã‚Œã¾ã™ã€‚</p>
        </div>
    </div>
</div>

<!-- Modal: Character Detail -->
<div id="modal-char-detail" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è©³ç´°</h3> <button class="close-modal">é–‰ã˜ã‚‹</button>
        </div>
        <div class="modal-body" id="detail-content">
            <!-- Content injected via JS -->
        </div>
    </div>
</div>

<!-- Modal: Rule Book -->
<div id="modal-rules" class="modal-overlay">
    <div class="modal-box">
        <div class="modal-header">
            <h3>ãƒ«ãƒ¼ãƒ«ãƒ–ãƒƒã‚¯ (Manual)</h3> <button class="close-modal">é–‰ã˜ã‚‹</button>
        </div>
        <div class="modal-body">
            <div class="rule-section">
                <h4>åŸºæœ¬ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
                <table class="rule-table">
                    <tr><td>STR (è…•åŠ›)</td><td>ç‰©ç†æ”»æ’ƒã®å¨åŠ›ã«å½±éŸ¿ã—ã¾ã™ã€‚æˆ¦å£«ç³»ã«ã¨ã£ã¦é‡è¦ã€‚</td></tr>
                    <tr><td>VIT (è€ä¹…)</td><td>ç‰©ç†é˜²å¾¡åŠ›ã¨HPæˆé•·ç‡ã«å½±éŸ¿ã—ã¾ã™ã€‚</td></tr>
                    <tr><td>MAG (é­”åŠ›)</td><td>é­”æ³•æ”»æ’ƒã®å¨åŠ›ã«å½±éŸ¿ã—ã¾ã™ã€‚é­”æ³•ç³»ã«ã¨ã£ã¦é‡è¦ã€‚</td></tr>
                    <tr><td>INT (çŸ¥åŠ›)</td><td>é­”æ³•é˜²å¾¡åŠ›ã‚„ã‚¹ã‚­ãƒ«ã®æˆåŠŸç‡ã«å½±éŸ¿ã—ã¾ã™ã€‚</td></tr>
                    <tr><td>AGI (ç´ æ—©)</td><td>å‘½ä¸­ç‡ã€å›é¿ç‡ã€è¡Œå‹•é †ã«å½±éŸ¿ã—ã¾ã™ã€‚</td></tr>
                    <tr><td>LUC (é‹)</td><td>ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ç‡ã€ã‚¢ã‚¤ãƒ†ãƒ ãƒ‰ãƒ­ãƒƒãƒ—ç‡ã«å½±éŸ¿ã—ã¾ã™ã€‚</td></tr>
                </table>
            </div>
            <div class="rule-section">
                <h4>æˆ¦é—˜ãƒ«ãƒ¼ãƒ«</h4>
                <p>æ”»æ’ƒã‚¿ã‚¤ãƒ—ã¯è·æ¥­ã«ã‚ˆã£ã¦ã€Œç‰©ç†ã€ã‹ã€Œé­”æ³•ã€ã«åˆ†ã‹ã‚Œã¾ã™ã€‚</p>
                <ul>
                    <li><strong>ç‰©ç†ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> (STR + æ­¦å™¨æ”»æ’ƒåŠ›) - (æ•µVIT / 2)</li>
                    <li><strong>é­”æ³•ãƒ€ãƒ¡ãƒ¼ã‚¸:</strong> (MAG + æ­¦å™¨é­”åŠ›) - (æ•µINT / 2)</li>
                </ul>
            </div>
            <div class="rule-section">
                <h4>å±æ€§ (Elements)</h4>
                <p>å±æ€§ã«ã¯æœ‰åˆ©ãƒ»ä¸åˆ©ã®ç›¸æ€§ãŒã‚ã‚Šã¾ã™ã€‚æœ‰åˆ©å±æ€§ã§æ”»æ’ƒã™ã‚‹ã¨ãƒ€ãƒ¡ãƒ¼ã‚¸1.5å€ã€ä¸åˆ©å±æ€§ã ã¨0.5å€ã«ãªã‚Šã¾ã™ã€‚</p>
                <p><strong>ç« > é¢¨ > åœŸ > æ°´ > ç«</strong> ï¼ˆ4ã™ãã¿ï¼‰<br>
                <strong>å…‰ <=> é—‡</strong> ï¼ˆäº’ã„ã«å¤§ãƒ€ãƒ¡ãƒ¼ã‚¸ï¼‰</p>
            </div>
            <div class="rule-section">
                <h4>è‡ªå‹•è£…å‚™ (Auto Equip)</h4>
                <p>æ¢ç´¢ä¸­ã€è£…å‚™å¯èƒ½ã§ã‹ã¤ç¾åœ¨ã‚ˆã‚Šã€Œç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã€ãŒé«˜ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’å…¥æ‰‹ã™ã‚‹ã¨ã€è‡ªå‹•çš„ã«è£…å‚™ã‚’æ›´æ–°ã—ã¾ã™ã€‚</p>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * Genetic Rogue Ver.11.2
 * - Fixed Settings Button visibility
 * - New Save Key (v11) to prevent conflicts
 * - Robust Initialization
 */

// --- 1. DATA DEFINITIONS ---

const ELEMENTS = {
    fire:  { name: "ç«", color: "#e74c3c" },
    water: { name: "æ°´", color: "#3498db" },
    wind:  { name: "é¢¨", color: "#2ecc71" },
    earth: { name: "åœŸ", color: "#d35400" },
    light: { name: "å…‰", color: "#f1c40f" },
    dark:  { name: "é—‡", color: "#9b59b6" }
};

const ELEMENT_CHART = {
    fire: { weak: 'water', strong: 'wind' },
    wind: { weak: 'fire', strong: 'earth' },
    earth: { weak: 'wind', strong: 'water' },
    water: { weak: 'earth', strong: 'fire' },
    light: { weak: 'dark', strong: 'dark' },
    dark: { weak: 'light', strong: 'light' }
};

const LINEAGE = {
    warrior: { hp: 1.5, atk: 1.5, def: 1.2, agi: 0.8, mag: 0.2, int: 0.6, luc: 1.0, color:"#e74c3c" },
    martial: { hp: 1.4, atk: 1.3, def: 0.9, agi: 1.5, mag: 0.5, int: 1.0, luc: 1.0, color:"#d35400" },
    shadow:  { hp: 0.9, atk: 1.2, def: 0.7, agi: 1.7, mag: 0.6, int: 1.3, luc: 1.6, color:"#8e44ad" },
    magic:   { hp: 0.7, atk: 0.3, def: 0.6, agi: 1.0, mag: 1.8, int: 1.6, luc: 1.0, color:"#3498db" },
    holy:    { hp: 1.1, atk: 0.7, def: 1.2, agi: 0.9, mag: 1.4, int: 1.5, luc: 1.2, color:"#f1c40f" },
    tech:    { hp: 1.2, atk: 1.0, def: 1.1, agi: 1.2, mag: 0.5, int: 1.6, luc: 1.1, color:"#1abc9c" },
    special: { hp: 1.0, atk: 0.8, def: 0.8, agi: 1.0, mag: 1.0, int: 1.3, luc: 2.0, color:"#2ecc71" }
};

const PERSONALITY_DATA = {
    "å‹‡æ•¢": { hp:1.2, atk:1.2 }, "å†·é™": { int:1.2, def:1.2 }, "è‡†ç—…": { agi:1.3, def:0.8 },
    "è±ªå¿«": { atk:1.3, mag:0.7 }, "å¤©æ‰": { mag:1.2, int:1.2, hp:0.8 }, "å¹¸é‹": { luc:1.5 },
    "å …å®Ÿ": { def:1.2, hp:1.2, agi:0.8 }, "å‡¡äºº": {}
};

const SKILL_POOL = {
    phy: ["å‰›è…•", "é€£æ’ƒ", "é‰„å£", "ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼", "æ€¥æ‰€çªã", "ç²‰ç •", "åº•åŠ›", "é—˜äº‰æœ¬èƒ½", "å—ã‘æµã—", "é¬¼ç¥"],
    mag: ["é­”åŠ›é›†ä¸­", "ç‘æƒ³", "ç‚ã®çŸ¥è­˜", "ãƒãƒŠåŠ¹ç‡", "è© å”±çŸ­ç¸®", "å±æ€§å¼·åŒ–", "çµç•Œ", "ç²¾ç¥çµ±ä¸€", "å¤ä»£ã®çŸ¥æµ", "é­”ç¥"],
    spd: ["æ—©æ¥­", "å›é¿", "ä¸æ„æ‰“ã¡", "æ®‹åƒ", "è»½æ¥­", "ç›®åˆ©ã", "äºŒåˆ€æµã®æ¥µæ„", "éš å¯†", "ä¿Šè¶³", "ç¥é€Ÿ"],
    tnk: ["æŒ‘ç™º", "ã‹ã°ã†", "å¿è€", "ãƒªã‚¸ã‚§ãƒ", "é‡è£…ç”²", "ä¸å±ˆ", "ã‚¬ãƒ¼ãƒ‡ã‚£ã‚¢ãƒ³", "è‡ªå·±ä¿®å¾©", "åŸå¡", "é‡‘å‰›"],
    sup: ["ç¥ˆã‚Š", "ç¥ç¦", "æ…ˆæ„›", "å¿œæ€¥æ‰‹å½“", "åŠ è­·", "è–¬ã®çŸ¥è­˜", "è–ãªã‚‹å…‰", "çŒ®èº«", "å¥³ç¥ã®ç³", "å¥‡è·¡"]
};

// atkType: 'phy'(Physical) or 'mag'(Magical)
// curve: 'early'(æ—©ç†Ÿ), 'avg'(æ™®é€š), 'late'(æ™©æˆ)
const JOB_DATA = {
    // T1
    warrior:   { name:"æˆ¦å£«", tier:1, type:"phy", atkType:"phy", curve:"avg", equip:["sw","ax","ha","la","sh","ac"], lineage:"warrior" },
    mage:      { name:"é­”æ³•ä½¿ã„", tier:1, type:"mag", atkType:"mag", curve:"late", equip:["st","dg","ro","ac"], lineage:"magic" },
    thief:     { name:"ç›—è³Š",   tier:1, type:"spd", atkType:"phy", curve:"early", equip:["dg","bow","la","to","ac"], lineage:"shadow" },
    priest:    { name:"åƒ§ä¾¶",  tier:1, type:"sup", atkType:"mag", curve:"avg", equip:["st","ro","sh","ac"], lineage:"holy" },
    merchant:  { name:"å•†äºº",tier:1, type:"spe", atkType:"phy", curve:"early", equip:["dg","la","ac"], lineage:"special" },
    monk:      { name:"æ­¦é—˜å®¶",    tier:1, type:"phy", atkType:"phy", curve:"avg", equip:["kn","la","ac"], lineage:"martial" },
    hunter:    { name:"ç‹©äºº",  tier:1, type:"tec", atkType:"phy", curve:"avg", equip:["bow","dg","la","to","ac"], lineage:"shadow" },
    
    // T2
    knight:    { name:"é¨å£«",  tier:2, type:"tnk", atkType:"phy", curve:"avg", equip:["sw","sp","ha","la","sh","ac"], lineage:"warrior", mod:{def:1.4} },
    samurai:   { name:"ä¾", tier:2, type:"phy", atkType:"phy", curve:"late", equip:["sw","bow","la","ac"], lineage:"martial", mod:{atk:1.5} },
    sorcerer:  { name:"é­”è¡“å¸«",tier:2, type:"mag", atkType:"mag", curve:"late", equip:["st","dg","ro","ac"], lineage:"magic", mod:{mag:1.7} },
    bard:      { name:"åŸéŠè©©äºº", tier:2, type:"sup", atkType:"mag", curve:"early", equip:["ins","dg","la","ro","ac"], lineage:"special", mod:{luc:1.5} },
    ninja:     { name:"å¿è€…",   tier:2, type:"spd", atkType:"phy", curve:"early", equip:["sw","dg","to","la","ac"], lineage:"shadow", mod:{agi:1.6}, reqEl:['wind','dark'] },
    gunner:    { name:"ã‚¬ãƒ³ãƒãƒ³",  tier:2, type:"tec", atkType:"phy", curve:"avg", equip:["gun","la","ac"], lineage:"tech", mod:{dex:1.5} },
    
    // T3
    paladin:   { name:"è–é¨å£«", tier:3, type:"tnk", atkType:"phy", curve:"late", equip:["sw","ha","sh","ac"], lineage:"warrior", mod:{def:1.8, mag:1.2}, reqEl:['light'] },
    sage:      { name:"è³¢è€…",    tier:3, type:"mag", atkType:"mag", curve:"late", equip:["st","ro","ac"], lineage:"magic", mod:{mag:2.0, int:2.0}, reqEl:['light','earth','water','fire','wind'] },
    assassin:  { name:"æš—æ®ºè€…",tier:3, type:"spd", atkType:"phy", curve:"early", equip:["dg","bow","to","la","ac"], lineage:"shadow", mod:{atk:2.2, agi:1.5}, reqEl:['dark'] },
    dragoon:   { name:"ç«œé¨å£«", tier:3, type:"phy", atkType:"phy", curve:"late", equip:["sp","ha","la","ac"], lineage:"warrior", mod:{atk:2.0, hp:1.5}, reqEl:['fire'] },
    sniper:    { name:"ç‹™æ’ƒæ‰‹",  tier:3, type:"tec", atkType:"phy", curve:"avg", equip:["gun","la","to","ac"], lineage:"tech", mod:{atk:2.0, dex:2.0} },
    
    // T4
    hero:      { name:"è‹±é›„",    tier:4, type:"phy", atkType:"phy", curve:"late", equip:["sw","ax","sp","ha","la","sh","ac"], lineage:"warrior", mod:{all:1.3, atk:2.5}, reqEl:['light'] },
    cyborg:    { name:"ã‚µã‚¤ãƒœãƒ¼ã‚°",  tier:4, type:"tnk", atkType:"phy", curve:"avg", equip:["dv","ax","gun","ha","ac"], lineage:"tech", mod:{hp:2.5, def:2.0} },
    demon:     { name:"é­”ç¥",   tier:4, type:"mag", atkType:"mag", curve:"late", equip:["st","dv","ro","ac"], lineage:"magic", mod:{mag:3.0, hp:2.0}, reqEl:['dark'] },
    marine:    { name:"å®‡å®™æµ·å…µ",tier:4, type:"phy", atkType:"phy", curve:"avg", equip:["gun","sw","ha","dv","ac"], lineage:"tech", mod:{atk:2.5, def:1.5} },
    psycho:    { name:"è¶…èƒ½åŠ›è€…",  tier:4, type:"mag", atkType:"mag", curve:"late", equip:["dv","ro","ac"], lineage:"magic", mod:{mag:2.5, int:2.5} },
    
    // Special
    jester:    { name:"éŠã³äºº",  tier:2, type:"spe", atkType:"phy", curve:"early", equip:["dg","ins","la","ro","ac"], lineage:"special", mod:{luc:3.0, hp:0.5} }
};

const TRAP_DATA = [
    { name: "ã‚¹ãƒ‘ã‚¤ã‚¯åºŠ", tier:1, type:"dmg", diff:10, dmg:20, msg:"é‹­ã„æ£˜ãŒé£›ã³å‡ºã—ãŸï¼" },
    { name: "æ¯’ã®çŸ¢", tier:1, type:"status", status:"psn", diff:15, msg:"æ¯’çŸ¢ãŒé£›ã‚“ã§ããŸï¼" },
    { name: "ç¡çœ ã‚¬ã‚¹", tier:2, type:"status", status:"slp", diff:20, msg:"å‚¬çœ ã‚¬ã‚¹ãŒå™´å°„ã•ã‚ŒãŸï¼" },
    { name: "è½ã¨ã—ç©´", tier:3, type:"floor", val:-1, diff:30, dmg:30, msg:"åºŠãŒæŠœã‘è½ã¡ãŸï¼" }
];

const ITEM_TEMPLATES = {
    w1: { name:"éŒ†ã³ãŸå‰£", kind:"sw", type:"weapon", slot:"main_hand", base:{atk:3}, tier:1 },
    w2: { name:"é‰„ã®å‰£", kind:"sw", type:"weapon", slot:"main_hand", base:{atk:8}, tier:1 },
    w3: { name:"é‹¼ã®æ–§", kind:"ax", type:"weapon", slot:"main_hand", base:{atk:15, agi:-2}, tier:2, req:{atk:20} }, // Req Str
    w4: { name:"ãƒ“ãƒ¼ãƒ ã‚µãƒ¼ãƒ™ãƒ«", kind:"sw", type:"weapon", slot:"main_hand", base:{atk:45, int:5}, tier:4 },
    w5: { name:"ã‚¦ã‚©ãƒ¼ãƒãƒ³ãƒãƒ¼", kind:"ax", type:"weapon", slot:"main_hand", base:{atk:25, agi:-5}, tier:3, req:{atk:40} },
    st1: { name:"æ¨«ã®æ–", kind:"st", type:"weapon", slot:"main_hand", base:{mag:5}, tier:1 },
    st2: { name:"ãƒ«ãƒ¼ãƒ³ã‚¹ã‚¿ãƒƒãƒ•", kind:"st", type:"weapon", slot:"main_hand", base:{mag:15}, tier:2 },
    kn1: { name:"ãƒ¬ã‚¶ãƒ¼ãƒŠãƒƒã‚¯ãƒ«", kind:"kn", type:"weapon", slot:"main_hand", base:{atk:5, agi:2}, tier:1 },
    
    a1: { name:"ãƒœãƒ­æœ", kind:"la", type:"armor", slot:"body", base:{def:1}, tier:1 },
    a2: { name:"é©ã®é§", kind:"la", type:"armor", slot:"body", base:{def:5}, tier:1 },
    a3: { name:"ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ¡ã‚¤ãƒ«", kind:"ha", type:"armor", slot:"body", base:{def:15, agi:-3}, tier:2, req:{def:20} }, // Req VIT
    a4: { name:"ãƒŠãƒã‚¹ãƒ¼ãƒ„", kind:"la", type:"armor", slot:"body", base:{def:30, hp:50}, tier:4 },
    ro1: { name:"ãƒ­ãƒ¼ãƒ–", kind:"ro", type:"armor", slot:"body", base:{def:2, mag:2}, tier:1 },
    
    ac1: { name:"ãƒªãƒ³ã‚°", kind:"ac", type:"accessory", slot:"accessory", base:{luc:2}, tier:1 }
};

const AFFIX_DATA = [
    { name:"éŒ†ã³ãŸ", tier:1, type:"bad", stats:{atk:-3, def:-1}, w:30 },
    { name:"é‹­åˆ©ãª", tier:1, type:"good", stats:{atk:3}, w:40 },
    { name:"è‹±é›„ã®", tier:4, type:"legend", stats:{all:5, atk:20}, w:5 }
];

const ENEMY_BASE = [
    { name:"ã‚¹ãƒ©ã‚¤ãƒ ", hp:20, atk:5, def:2, exp:10, gold:5, elem: 'water' },
    { name:"ãƒã‚ºãƒŸ", hp:15, atk:7, def:1, exp:12, gold:7, elem: 'earth' },
    { name:"ã‚´ãƒ–ãƒªãƒ³", hp:30, atk:8, def:3, exp:15, gold:10, elem: 'earth' },
    { name:"ã‚ªãƒ¼ã‚¯", hp:60, atk:15, def:5, exp:25, gold:20, elem: 'fire' },
    { name:"ã‚´ãƒ¼ãƒ¬ãƒ ", hp:150, atk:30, def:20, exp:80, gold:50, elem: 'earth' },
    { name:"ã‚¦ã‚£ãƒ«ã‚ªã‚¦ã‚£ã‚¹ãƒ—", hp:40, atk:25, def:0, exp:40, gold:30, elem: 'fire' },
    { name:"ãƒ‰ãƒ©ã‚´ãƒ³", hp:500, atk:80, def:30, exp:300, gold:200, elem: 'fire' }
];

const ENEMY_PREFIXES = [
    { name: "ç‹‚æš´ãª", mod: { atk: 1.5, exp: 1.5 } },
    { name: "å·¨å¤§ãª", mod: { hp: 2.0, atk: 1.2, exp: 2.0 } },
    { name: "ç¥é€Ÿã®", mod: { agi: 2.0, exp: 1.5 } },
    { name: "ç¡¬ã„", mod: { def: 2.0, exp: 1.5 } }
];

const CONFIG = {
    MAX_PARTY: 6,
    BREED_MIN_LV: 30, 
    HIRE_COST: 30, CC_COST: 100,
    MAX_LEVEL: 50,
    BASE_STATS: { hp:50, atk:5, def:5, agi:5, mag:5, int:5, luc:5 },
    FLOOR_STEP_MAX: 30
};

// --- 3. LOGIC ---

const LootSystem = {
    generate(floor) {
        if (Math.random() > (0.05 + floor * 0.005)) return null;
        const maxTier = Math.min(5, Math.ceil(floor / 5));
        const templates = Object.values(ITEM_TEMPLATES).filter(t => t.tier <= maxTier);
        if(templates.length === 0) return null;
        const tpl = templates[Math.floor(Math.random() * templates.length)];

        let rarity = 2; 
        const rRoll = Math.random() + (floor * 0.01);
        if (rRoll > 0.95) rarity = 5; else if (rRoll > 0.85) rarity = 4; else if (rRoll > 0.60) rarity = 3; else if (rRoll < 0.20) rarity = 1;
        rarity = Math.min(rarity, maxTier + 2);

        let item = { 
            uid: Math.random().toString(36).substr(2), 
            name: tpl.name, kind: tpl.kind, type: tpl.type, slot: tpl.slot, 
            stats: { ...tpl.base }, rarity: rarity, req: tpl.req 
        };

        if (rarity !== 2) {
            const pool = AFFIX_DATA.filter(a => rarity === 1 ? a.type === "bad" : a.tier <= rarity - 1);
            if (pool.length > 0) {
                const affix = pool[Math.floor(Math.random() * pool.length)];
                item.name = `${affix.name}${item.name}`;
                for(let k in affix.stats) {
                    if(k === 'all') ['atk','def','agi','mag','int','luc'].forEach(s => item.stats[s] = (item.stats[s]||0) + affix.stats.all);
                    else item.stats[k] = (item.stats[k]||0) + affix.stats[k];
                }
            }
        }
        return item;
    }
};

class Character {
    constructor(jobKey, parents=null, fromLoad=null) {
        if(fromLoad) {
            Object.assign(this, fromLoad);
            return;
        }

        this.id = Math.random().toString(36).substr(2, 9);
        this.jobKey = jobKey;
        this.name = this.genName();
        this.level = 1;
        this.exp = 0;
        this.maxExp = 100;
        this.generation = parents ? Math.max(parents[0].generation, parents[1].generation)+1 : 1;
        
        const pKeys = Object.keys(PERSONALITY_DATA);
        this.personality = pKeys[Math.floor(Math.random()*pKeys.length)];
        this.skills = [];
        this.elements = parents ? this.inheritElements(parents[0], parents[1]) : this.genElements();
        this.bonusStats = {}; 
        this.equipment = { main_hand: null, off_hand: null, head: null, body: null, accessory: null };
        this.status = {};
        
        this.baseStats = {};
        for(let k in CONFIG.BASE_STATS) {
            let base = CONFIG.BASE_STATS[k];
            if(parents) base = (parents[0].baseStats[k] + parents[1].baseStats[k]) / 2 * 1.1;
            this.baseStats[k] = Math.floor(base * (0.9 + Math.random()*0.2));
            this.bonusStats[k] = 0;
        }
        this.hp = this.totalStats.hp;
    }

    genName() {
        const n = ["ã‚¢ãƒ¬ã‚¯","ãƒ™ãƒ«","ã‚·ãƒ‰","ãƒ€ãƒ³","ã‚¤ãƒ´","ãƒ•ã‚§ã‚¤","ã‚¸ãƒ³","ãƒãƒ«","ã‚¤ã‚¢ãƒ³","ã‚¸ã‚§ã‚¤","ã‚«ã‚¤","ãƒ¬ã‚ª"];
        return n[Math.floor(Math.random()*n.length)] + Math.floor(Math.random()*99);
    }

    genElements() {
        if(Math.random() < 0.3) {
            const keys = Object.keys(ELEMENTS);
            return [keys[Math.floor(Math.random() * keys.length)]];
        }
        return [];
    }

    inheritElements(p1, p2) {
        const pool = [...new Set([...p1.elements, ...p2.elements])];
        if(pool.length === 0) return [];
        let guarantee = Math.max(1, Math.floor((p1.elements.length + p2.elements.length) / 2));
        guarantee = Math.min(guarantee, pool.length);
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        const childEls = pool.slice(0, guarantee);
        for(let i = guarantee; i < pool.length; i++) {
            let chance = 0.2 / Math.pow(2, childEls.length);
            if(Math.random() < chance) childEls.push(pool[i]);
        }
        return childEls;
    }

    get job() { return JOB_DATA[this.jobKey]; }
    get breedCost() { return 100 + (this.level * 5); }

    get totalStats() {
        let s = {};
        let mod = this.job.mod || {};
        let lineage = LINEAGE[this.job.lineage];
        let pers = PERSONALITY_DATA[this.personality];

        let curveMult = 1.0;
        let progress = this.level / CONFIG.MAX_LEVEL;
        
        if (this.job.curve === 'early') curveMult = 1.5 - progress; 
        else if (this.job.curve === 'late') curveMult = 0.5 + progress;

        for(let k in CONFIG.BASE_STATS) {
            let val = this.baseStats[k] + (this.bonusStats[k] || 0);
            let growthBase = (CONFIG.BASE_STATS[k] * 0.2); 
            let multipliers = (lineage[k] || 1.0) * (mod[k] || mod.all || 1.0) * (pers[k] || 1.0);
            let gainedStats = growthBase * multipliers * (this.level - 1) * curveMult;
            val += gainedStats;
            s[k] = Math.floor(val);
        }
        for(let slot in this.equipment) {
            let item = this.equipment[slot];
            if(item) { for(let k in item.stats) s[k] = (s[k]||0) + item.stats[k]; }
        }
        return s;
    }

    get battleStats() {
        const s = this.totalStats;
        const isMag = this.job.atkType === 'mag';
        let pAtk = s.atk; 
        let mAtk = s.mag; 
        let def = s.def; 
        let mDef = s.int;
        return { pAtk: pAtk, mAtk: mAtk, def: def, mDef: mDef, hit: s.agi * 1.5 + s.luc * 0.5, crit: s.luc * 0.2 + (s.dex || 0) * 0.1, isMag: isMag };
    }

    canEquip(item) {
        if (!this.job.equip.includes(item.kind) && item.kind !== 'ac') return { ok: false, reason: "è·æ¥­ä¸å¯" };
        if (item.req) {
            const s = this.totalStats;
            for(let key in item.req) {
                if (s[key] < item.req[key]) return { ok: false, reason: `${key.toUpperCase()}ä¸è¶³` };
            }
        }
        return { ok: true };
    }

    equip(item) {
        const check = this.canEquip(item);
        if (!check.ok) { return false; } 
        if(this.equipment[item.slot]) Game.inventory.push(this.equipment[item.slot]);
        this.equipment[item.slot] = item;
        this.hp = Math.min(this.hp, this.totalStats.hp);
        Game.save();
        return true;
    }
    unequip(slot) {
        if(this.equipment[slot]) {
            Game.inventory.push(this.equipment[slot]);
            this.equipment[slot] = null;
            Game.save();
        }
    }

    getItemScore(item) {
        if (!item) return 0;
        if (!this.canEquip(item).ok) return -1;
        let s = 0;
        if (this.job.atkType === 'mag') {
            s += (item.stats.mag || 0) * 1.5;
            s += (item.stats.int || 0) * 1.0;
            s += (item.stats.atk || 0) * 0.2;
        } else {
            s += (item.stats.atk || 0) * 1.5;
            s += (item.stats.def || 0) * 0.5;
            s += (item.stats.mag || 0) * 0.1;
        }
        s += (item.stats.def || 0) * 1.0;
        s += (item.stats.hp || 0) * 0.2;
        s += (item.stats.agi || 0) * 0.8;
        s += (item.stats.luc || 0) * 0.5;
        return s;
    }

    gainExp(v) {
        if(this.level >= CONFIG.MAX_LEVEL) return null;
        this.exp += Math.floor(v);
        if(this.exp >= this.maxExp) {
            let oldStats = this.totalStats;
            this.level++;
            this.exp -= this.maxExp;
            this.maxExp = Math.floor(this.maxExp * 1.2);
            let newStats = this.totalStats;
            this.hp = this.totalStats.hp;
            let diffs = [];
            for(let k in oldStats) {
                let d = newStats[k] - oldStats[k];
                if(d > 0) diffs.push(`${k.toUpperCase()}+${d}`);
            }
            if(this.level % 5 === 0 && this.skills.length < 10) this.learnSkill();
            return diffs;
        }
        return null;
    }

    learnSkill() {
        let type = this.job.type === 'tnk' ? 'tnk' : (this.job.type === 'spd' ? 'spd' : (this.job.type === 'mag' ? 'mag' : (this.job.type === 'sup' ? 'sup' : 'phy')));
        let pool = SKILL_POOL[type] || SKILL_POOL['phy'];
        for(let s of pool) {
            if(!this.skills.includes(s)) {
                this.skills.push(s);
                return s;
            }
        }
        return null;
    }

    classChange(newJobKey) {
        let s = this.totalStats;
        for(let k in CONFIG.BASE_STATS) this.bonusStats[k] = (this.bonusStats[k] || 0) + Math.floor(s[k] * 0.1);
        this.jobKey = newJobKey;
        this.level = 1; this.maxExp = 100; this.hp = this.totalStats.hp;
        Game.save();
    }
}

// --- GAME ENGINE ---

const Game = {
    helix: 100, floor: 1, maxFloor: 1, floorProgress: 0,
    party: [], roster: [], inventory: [],
    exploring: false, timer: null,
    currentEnemy: null, // è¿½åŠ 

    init() {
        // USE NEW SAVE KEY to prevent conflict
        if(localStorage.getItem('genetic_rogue_v11_save')) {
            this.load();
        } else {
            ["warrior","thief","priest"].forEach(j => this.roster.push(new Character(j)));
            this.roster.forEach(c => this.party.push(c));
            let starter = LootSystem.generate(1);
            if(!starter) starter = { uid: "starter", name:"ç²—æœ«ãªå‰£", kind:"sw", type:"weapon", slot:"main_hand", stats:{atk:2}, rarity:1 };
            this.inventory.push(starter);
            this.save();
        }
        UI.init();
        UI.updateAll();
        UI.log("Genetic Rogue Ver.11.2 èµ·å‹•ã€‚", "log-sys");
    },

    save(manual=false) {
        const data = {
            helix: this.helix, maxFloor: this.maxFloor, inventory: this.inventory,
            roster: this.roster, partyIds: this.party.map(c => c.id)
        };
        localStorage.setItem('genetic_rogue_v11_save', JSON.stringify(data));
        if(manual) UI.log("ãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸã€‚", "log-sys");
    },

    load() {
        try {
            const data = JSON.parse(localStorage.getItem('genetic_rogue_v11_save'));
            if(!data) return;
            this.helix = data.helix; this.maxFloor = data.maxFloor; this.inventory = data.inventory || [];
            this.roster = data.roster.map(d => new Character(null, null, d));
            this.party = [];
            data.partyIds.forEach(id => {
                const c = this.roster.find(x => x.id === id);
                if(c) this.party.push(c);
            });
            UI.log("ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚", "log-sys");
        } catch(e) {
            console.error("Save data corrupt", e);
            // Safe fallback logic could go here
        }
    },

    resetSave() {
        if(confirm("æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
            localStorage.removeItem('genetic_rogue_v11_save');
            location.reload();
        }
    },

    explore(startFloor) {
        if(this.party.length===0) return alert("ãƒ‘ãƒ¼ãƒ†ã‚£ãŒã„ã¾ã›ã‚“");
        if(this.party.every(c => c.hp <= 0)) {
            this.party.forEach(c => c.hp = c.totalStats.hp);
            UI.updateAll();
        }
        
        this.floor = parseInt(startFloor);
        this.floorProgress = 0;
        this.exploring = true;
        this.currentEnemy = null; // å®‰å…¨ã®ãŸã‚ãƒªã‚»ãƒƒãƒˆ
        UI.toggle(true);
        UI.log(`éšå±¤ ${this.floor} ã®æ¢ç´¢ã‚’é–‹å§‹ã—ã¾ã™`);
        this.timer = setInterval(() => this.tick(), 1000);
    },

    stop() {
        this.exploring = false;
        clearInterval(this.timer);
        this.party.forEach(c => { 
            c.hp = c.totalStats.hp;
            c.status = {}; 
        });
        this.currentEnemy = null; // ãƒªã‚»ãƒƒãƒˆ
        this.save();
        UI.toggle(false);
        UI.updateAll();
        UI.log("æ‹ ç‚¹ã«å¸°é‚„ã—ã¾ã—ãŸã€‚å…¨ãƒ¡ãƒ³ãƒãƒ¼ã®HPã‚’å…¨å›å¾©ã—ã¾ã—ãŸã€‚");
    },

    tick() {
        if(this.party.every(c => c.hp <= 0)) {
            this.exploring = false;
            clearInterval(this.timer);
            UI.log("å…¨æ»…ã—ã¾ã—ãŸ... æœ€é«˜åˆ°é”éšå±¤ãƒªã‚»ãƒƒãƒˆã€‚", "log-defeat");
            this.maxFloor = 1; this.floor = 1;
            this.party.forEach(c => { c.hp = c.totalStats.hp; c.status = {}; });
            this.currentEnemy = null;
            this.save();
            UI.toggle(false);
            UI.updateAll();
            return;
        }

        // çŠ¶æ…‹ç•°å¸¸å‡¦ç†
        this.party.forEach(c => {
            if(c.hp > 0 && c.status.psn) { c.hp -= Math.ceil(c.totalStats.hp * 0.05); c.status.psn--; if(c.status.psn<=0) delete c.status.psn; }
            if(c.status.slp) { c.status.slp--; if(c.status.slp<=0) delete c.status.slp; }
        });

        // â˜…ä¿®æ­£: æˆ¦é—˜ä¸­ã¯æ­©æ•°ã‚’é€²ã‚ãªã„
        if (this.currentEnemy) {
            this.combat();
        } else {
            this.floorProgress++;
            if(this.floorProgress > CONFIG.FLOOR_STEP_MAX) {
                this.floor++;
                this.floorProgress = 0;
                if(this.floor > this.maxFloor) this.maxFloor = this.floor;
                UI.log(`>>> éšå±¤ ${this.floor} ã¸é€²ã‚“ã `, "log-victory");
            }
            UI.updateHeader();

            const r = Math.random();
            if (r < 0.2) this.trap();
            else if (r < 0.8) this.combat(); // æ–°è¦æˆ¦é—˜
            else this.event();
        }

        UI.renderParty();
    },

    autoEquip(item) {
        if(!item) return;
        let equippedBy = null;
        for(let c of this.party) {
            if(c.canEquip(item).ok) {
                let currentItem = c.equipment[item.slot];
                let currentScore = currentItem ? c.getItemScore(currentItem) : 0;
                let newScore = c.getItemScore(item);
                if(newScore > currentScore) {
                    c.equip(item);
                    equippedBy = c.name;
                    break;
                }
            }
        }
        if(equippedBy) {
            UI.log(`[è‡ªå‹•è£…å‚™] ${equippedBy} ã¯ ${item.name} ã‚’è£…å‚™ï¼`, "log-equip");
        } else {
            this.inventory.push(item);
            UI.log(`æˆ¦åˆ©å“: ${item.name}`, "log-item");
        }
    },

    trap() {
        const activeParty = this.party.filter(c => c.hp > 0 && !c.status.slp);
        if(activeParty.length === 0) return;
        const tier = Math.min(4, Math.ceil(this.floor / 5));
        const pool = TRAP_DATA.filter(t => t.tier <= tier);
        const trap = pool[Math.floor(Math.random() * pool.length)];
        UI.log(`ï¼ ${trap.msg}`, "log-trap");
        
        const detector = activeParty.reduce((p, c) => {
            const s = c.totalStats;
            const val = Math.max(s.int, s.agi);
            return (val > p.val) ? {char:c, val:val} : p;
        }, {val:0});
        if (detector.val < trap.diff) { this.triggerTrap(trap); return; }
        const disarmer = activeParty.reduce((p, c) => {
            const s = c.totalStats;
            let val = Math.max(s.dex||0, s.agi, s.luc);
            if (['thief','ninja','hunter','assassin'].includes(c.jobKey)) val += 20; 
            return (val > p.val) ? {char:c, val:val} : p;
        }, {val:0});
        if ((disarmer.val + Math.random()*10) >= trap.diff) { 
            UI.log(`${disarmer.char.name}ãŒè§£é™¤æˆåŠŸï¼`, "log-trap-ok"); 
            let diff = disarmer.char.gainExp(5);
            if(diff) UI.log(`${disarmer.char.name} LvUp! [${diff.join(', ')}]`, "log-lvlup");
        } 
        else { UI.log(`${disarmer.char.name}ã¯å¤±æ•—ã—ãŸï¼`, "log-trap"); this.triggerTrap(trap); }
    },

    triggerTrap(trap) {
        if(trap.type === "dmg") {
            this.party.forEach(c => { if(c.hp>0){ c.hp-=trap.dmg; UI.log(`${c.name}ã«${trap.dmg}ãƒ€ãƒ¡`,"log-dmg"); } });
        } else if (trap.type === "status") {
            this.party.forEach(c => { if(c.hp>0){ c.status[trap.status]=3; UI.log(`${c.name}ã¯${trap.status==='psn'?'æ¯’':'çœ ã‚Š'}ã‚’å—ã‘ãŸ`,"log-trap"); } });
        } else if (trap.type === "floor") {
            this.floor = Math.max(1, this.floor + trap.val); this.floorProgress = 0; UI.log(`éšå±¤${this.floor}ã¸è½ã¡ãŸï¼`,"log-trap");
        }
    },

    combat(isForce=false) {
        const activeParty = this.party.filter(c => c.hp > 0);
        if(activeParty.length === 0) return;
        
        let enemy;

        if (this.currentEnemy) {
            enemy = this.currentEnemy;
        } else {
            // æ–°è¦æ•µç”Ÿæˆ
            let scale = 1 + (this.floor - 1) * 0.4;
            let isElite = !isForce && (this.floor % 5 === 0);
            if(isElite) scale *= 1.5;
            
            let eBase = ENEMY_BASE[Math.min(ENEMY_BASE.length-1, Math.floor((this.floor-1)/2))];
            let prefix = isElite ? ENEMY_PREFIXES[Math.floor(Math.random()*ENEMY_PREFIXES.length)] : null;
            
            enemy = {
                name: (prefix ? prefix.name : "") + eBase.name,
                hp: Math.floor(eBase.hp * scale * (prefix ? prefix.mod.hp || 1 : 1)),
                atk: Math.floor(eBase.atk * scale * (prefix ? prefix.mod.atk || 1 : 1)),
                def: Math.floor(eBase.def * scale * (prefix ? prefix.mod.def || 1 : 1)), 
                agi: Math.floor(scale * 10 * (prefix ? prefix.mod.agi || 1 : 1)), 
                exp: Math.floor(eBase.exp * scale * (prefix ? prefix.mod.exp || 1 : 1)),
                gold: Math.floor(eBase.gold * scale),
                elem: eBase.elem
            };
            this.currentEnemy = enemy; // æˆ¦é—˜é–‹å§‹
            
            let eElemName = ELEMENTS[enemy.elem] ? ELEMENTS[enemy.elem].name : "ç„¡";
            UI.log(`é­é‡: ${enemy.name} (${eElemName}) HP:${enemy.hp}`, isElite?"log-elite":"log-combat");
        }

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æ”»æ’ƒå‡¦ç†
        activeParty.forEach(c => {
            if(enemy.hp <= 0) return;
            if(c.status.slp) return;
            
            const stats = c.battleStats;
            let dmg = 0;
            let hitChance = 0.8 + (stats.hit / (enemy.agi * 2));
            if (Math.random() > hitChance) {
                UI.log(`${c.name}ã®æ”»æ’ƒã¯å¤–ã‚ŒãŸ`, "log-dmg");
                return;
            }

            if (stats.isMag) {
                dmg = Math.max(1, stats.mAtk - (enemy.def * 0.8)); 
            } else {
                dmg = Math.max(1, stats.pAtk - enemy.def);
            }
            
            dmg = Math.floor(dmg * (0.9 + Math.random() * 0.2));

            let mod = 1.0;
            if (enemy.elem && c.elements.length > 0) {
                let bestMod = 1.0;
                c.elements.forEach(el => {
                    if (ELEMENT_CHART[el].strong === enemy.elem) bestMod = 1.5;
                    else if (ELEMENT_CHART[el].weak === enemy.elem && bestMod < 1.0) bestMod = 0.5;
                });
                mod = bestMod;
            }
            dmg = Math.floor(dmg * mod);
            let weakLog = mod > 1.0 ? "(å¼±ç‚¹!)" : (mod < 1.0 ? "(åŠæ¸›)" : "");

            if(Math.random() < (stats.crit / 100)) { dmg *= 2; UI.log("ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ï¼", "stat-bonus"); }
            
            enemy.hp -= dmg;
            UI.log(`${c.name}ã®æ”»æ’ƒ${weakLog} -> ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸`);
        });

        // æ•µã®ã‚¿ãƒ¼ãƒ³ã¾ãŸã¯æˆ¦é—˜çµ‚äº†åˆ¤å®š
        if(enemy.hp > 0) {
            let target = activeParty[Math.floor(Math.random() * activeParty.length)];
            let s = target.battleStats;
            let dmg = Math.max(1, Math.floor(enemy.atk - s.def));
            target.hp -= dmg;
            UI.log(`${target.name}ã¯ ${dmg} ãƒ€ãƒ¡ãƒ¼ã‚¸å—ã‘ãŸ`, "log-dmg");
            if(target.hp <= 0) UI.log(`${target.name} ã¯å€’ã‚ŒãŸ...`, "log-defeat");
        } else {
            UI.log(`å‹åˆ©ï¼ +${enemy.gold}G`);
            this.helix += enemy.gold;
            this.party.forEach(c => { 
                if(c.hp>0) {
                    let diff = c.gainExp(enemy.exp);
                    if(diff) {
                        UI.log(`${c.name} LvUp! [${diff.join(', ')}]`, "log-lvlup");
                    }
                } 
            });
            let item = LootSystem.generate(this.floor);
            this.autoEquip(item);
            this.currentEnemy = null; // æˆ¦é—˜çµ‚äº†
        }
    },

    event() { let g = 5 + this.floor; this.helix += g; UI.log(`${g} Helixã‚’ç™ºè¦‹`); },

    hire(targetJob) {
        if(this.helix < CONFIG.HIRE_COST) return;
        this.helix -= CONFIG.HIRE_COST;
        let key = targetJob;
        if (!key) {
            let keys = Object.keys(JOB_DATA).filter(k=>JOB_DATA[k].tier===1);
            key = keys[Math.floor(Math.random()*keys.length)];
        }
        let c = new Character(key);
        this.roster.push(c);
        UI.log(`é›‡ç”¨: ${c.name}`);
        this.save();
        UI.updateAll();
    },

    breed(id1, id2) {
        let p1 = this.roster.find(c=>c.id===id1);
        let p2 = this.roster.find(c=>c.id===id2);
        let cost = p1.breedCost + p2.breedCost;
        if(this.helix < cost) return alert("Helixä¸è¶³");
        if(p1.level < CONFIG.BREED_MIN_LV || p2.level < CONFIG.BREED_MIN_LV) return alert("è¦ªã¯Lv30ä»¥ä¸Šå¿…è¦ã§ã™");
        this.helix -= cost;
        let c = new Character(p1.jobKey, [p1,p2]);
        this.roster.push(c);
        UI.log(`èª•ç”Ÿ: ${c.name} (å±æ€§:${c.elements.map(e=>ELEMENTS[e].name).join(',')})`);
        this.save();
        UI.updateAll();
    },
    
    classChange(charId, jobKey) {
        if(this.helix < CONFIG.CC_COST) return;
        let c = this.roster.find(x=>x.id===charId);
        if(c.level < 10) return alert("Lv10ä»¥ä¸Šå¿…è¦ã§ã™");
        this.helix -= CONFIG.CC_COST;
        c.classChange(jobKey);
        UI.log(`${c.name} ã¯ ${JOB_DATA[jobKey].name} ã«è»¢è·ã—ãŸï¼`);
        this.save();
        UI.updateAll();
    }
};

// --- UI CONTROLLER ---
const UI = {
    sel: [], equipChar: null, ccChar: null,

    init() {
        document.getElementById('btn-explore').onclick = () => Game.explore(document.getElementById('floor-select').value);
        document.getElementById('btn-return').onclick = () => Game.stop();
        document.getElementById('btn-lab').onclick = () => this.openModal('modal-lab', this.renderLabRoster);
        document.getElementById('btn-inv').onclick = () => this.openModal('modal-inv', this.renderInv);
        document.getElementById('btn-settings').onclick = () => this.openModal('modal-settings');
        document.getElementById('btn-help').onclick = () => this.openModal('modal-rules');
        document.querySelectorAll('.close-modal').forEach(b => b.onclick = () => document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'));

        document.getElementById('act-breed').onclick = () => { if(this.sel.length===2){ Game.breed(this.sel[0], this.sel[1]); this.sel=[]; this.renderLabRoster(); }};
        document.getElementById('act-party').onclick = () => { this.sel.forEach(id => {
            let c = Game.roster.find(x=>x.id===id);
            let idx = Game.party.indexOf(c);
            idx>-1 ? Game.party.splice(idx,1) : (Game.party.length<CONFIG.MAX_PARTY && Game.party.push(c));
        }); this.sel=[]; this.renderLabRoster(); };

        document.getElementById('hire-cost').innerText = CONFIG.HIRE_COST;
    },

    updateAll() { this.updateHeader(); this.renderParty(); },
    updateHeader() {
        document.getElementById('helix-display').innerText = Game.helix;
        document.getElementById('floor-display').innerText = Game.floor;
        document.getElementById('floor-progress').innerText = `(${Game.floorProgress}/${CONFIG.FLOOR_STEP_MAX})`;
        document.getElementById('max-floor').innerText = Game.maxReachedFloor || Game.maxFloor;
        const sel = document.getElementById('floor-select');
        const currentOpt = parseInt(sel.value);
        sel.innerHTML = "";
        for(let i=1; i<=Game.maxFloor; i+=5) {
            let opt = document.createElement('option');
            opt.value = i; opt.innerText = `${i}F`;
            if(i === 1 || i === currentOpt) opt.selected = true;
            sel.appendChild(opt);
        }
        if(Game.maxFloor % 5 !== 1) {
            let opt = document.createElement('option');
            opt.value = Game.maxFloor; opt.innerText = `${Game.maxFloor}F`;
            sel.appendChild(opt);
        }
    },
    toggle(on) {
        document.getElementById('btn-explore').disabled = on;
        document.getElementById('btn-return').disabled = !on;
        document.getElementById('floor-select').disabled = on;
    },
    log(msg, type='') {
        let d = document.getElementById('log-list');
        d.innerHTML += `<div class="log-entry ${type}">${msg}</div>`;
        document.getElementById('log-panel').scrollTop = 99999;
    },

    renderParty() {
        const d = document.getElementById('party-container'); d.innerHTML = "";
        Game.party.forEach(c => {
            let s = c.totalStats;
            let hpP = (c.hp / s.hp) * 100;
            if(c.hp <= 0) hpP = 0;
            let expP = (c.exp / c.maxExp) * 100;
            
            let badges = "";
            if(c.status.psn) badges += `<span class="status-badge st-psn">æ¯’</span>`;
            if(c.status.slp) badges += `<span class="status-badge st-slp">çœ </span>`;

            let elems = c.elements.map(e => `<span class="elem-icon el-${e}" title="${ELEMENTS[e].name}"></span>`).join('');

            let items = "";
            for(let k in c.equipment) {
                if(c.equipment[k]) items += `<div class="equip-slot equip-active rar-${c.equipment[k].rarity}">${k.substr(0,2)}: ${c.equipment[k].name}</div>`;
                else items += `<div class="equip-slot">${k.substr(0,2)}: -</div>`;
            }
            let skills = c.skills.map(sk => `<span class="skill-tag">${sk}</span>`).join('');

            const card = document.createElement('div');
            card.className = `char-card ${c.hp<=0 ? 'dead' : ''}`;
            card.style.borderLeft = `3px solid ${LINEAGE[c.job.lineage].color || '#fff'}`;
            card.innerHTML = `
                <div class="char-header">
                    <span>${badges}${c.name} ${elems}</span> <span class="job-label">${c.job.name} Lv${c.level}</span>
                </div>
                <div class="personality-label">${c.personality}</div>
                <div class="bar-container">
                    <div class="bar-row">
                        <span style="width:20px;">HP</span>
                        <div class="bar-wrap"><div class="bar-val hp-bar" style="width:${hpP}%"></div></div>
                    </div>
                    <div class="bar-row">
                        <span style="width:20px;">EXP</span>
                        <div class="bar-wrap"><div class="bar-val exp-bar" style="width:${expP}%"></div></div>
                    </div>
                </div>
                <div class="stat-grid">
                    <div class="stat-val">STR: <span>${s.atk}</span></div>
                    <div class="stat-val">VIT: <span>${s.def}</span></div>
                    <div class="stat-val">MAG: <span>${s.mag}</span></div>
                    <div class="stat-val">HP: <span>${c.hp}/${s.hp}</span></div>
                </div>
                <div class="skill-list">${skills}</div>
                <div class="equip-grid">${items}</div>
            `;
            card.onclick = (e) => {
                UI.showCharDetail(c);
            };
            d.appendChild(card);
        });
    },

    openModal(id, fn) { document.getElementById(id).style.display = 'flex'; this.sel = []; if(fn) fn.call(this); },
    switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-'+tabName).style.display = 'block';
        event.target.classList.add('active');
        if(tabName==='lab-roster') this.renderLabRoster();
        if(tabName==='lab-hire') this.renderGuild();
        if(tabName==='lab-class') this.renderClassChange();
    },

    renderLabRoster() {
        const d = document.getElementById('lab-list'); d.innerHTML = "";
        Game.roster.forEach(c => {
            let sel = this.sel.includes(c.id);
            let inPt = Game.party.includes(c);
            let el = document.createElement('div');
            el.className = `list-item ${sel?'selected':''}`;
            if(inPt) el.style.borderRight = "3px solid var(--accent-color)";
            
            let elems = c.elements.map(e => `<span class="elem-icon el-${e}"></span>`).join('');
            
            el.innerHTML = `
                <div style="font-weight:bold;">${c.name} ${elems}</div>
                <div style="font-size:10px; color:#888;">${c.job.name} Lv${c.level}</div>
            `;
            el.onclick = () => {
                sel ? this.sel=this.sel.filter(x=>x!==c.id) : this.sel.push(c.id);
                this.renderLabRoster();
                const btn = document.getElementById('act-breed');
                if(this.sel.length === 2) {
                    let p1 = Game.roster.find(x=>x.id===this.sel[0]);
                    let p2 = Game.roster.find(x=>x.id===this.sel[1]);
                    btn.innerText = `é…åˆ (${p1.breedCost + p2.breedCost}G)`;
                    btn.disabled = false;
                } else {
                    btn.innerText = "é…åˆ";
                    btn.disabled = true;
                }
                document.getElementById('act-party').disabled = this.sel.length===0;
            };
            d.appendChild(el);
        });
    },
    renderGuild() {
        const d = document.getElementById('guild-list'); d.innerHTML = "";
        Object.keys(JOB_DATA).filter(k=>JOB_DATA[k].tier===1).forEach(k => {
            let job = JOB_DATA[k];
            let el = document.createElement('div');
            el.className = 'list-item';
            el.innerHTML = `<div>${job.name}</div><div style="font-size:10px;">${job.type}</div>`;
            el.onclick = () => { Game.hire(k); this.updateAll(); };
            d.appendChild(el);
        });
    },
    renderClassChange() {
        const cList = document.getElementById('cc-char-list'); cList.innerHTML = "";
        Game.roster.forEach(c => {
            let el = document.createElement('div');
            el.className = `list-item ${this.ccChar===c?'selected':''}`;
            el.innerHTML = `<div>${c.name}</div><div style="font-size:10px;">Lv${c.level} ${c.job.name}</div>`;
            el.onclick = () => { this.ccChar = c; this.renderClassChange(); };
            cList.appendChild(el);
        });
        const jList = document.getElementById('cc-job-list'); jList.innerHTML = "";
        if(!this.ccChar) { jList.innerHTML = "ã‚­ãƒ£ãƒ©ã‚’é¸æŠ"; return; }
        Object.keys(JOB_DATA).forEach(k => {
            let job = JOB_DATA[k];
            let el = document.createElement('div');
            el.className = 'list-item';
            
            let lvReq = this.ccChar.level >= 10;
            let elReq = true;
            if(job.reqEl) {
                elReq = job.reqEl.some(r => this.ccChar.elements.includes(r));
            }
            let costReq = Game.helix >= CONFIG.CC_COST;
            
            let can = lvReq && elReq && costReq;
            if(!can) el.classList.add('disabled');
            
            let reqText = job.reqEl ? `[å±æ€§:${job.reqEl.map(e=>ELEMENTS[e].name).join(',')}]` : "";
            
            el.innerHTML = `<div>${job.name} ${reqText}</div><div style="font-size:10px;">Tier ${job.tier}</div>`;
            if(can) el.onclick = () => { Game.classChange(this.ccChar.id, k); this.renderClassChange(); };
            jList.appendChild(el);
        });
    },
    renderInv() {
        const cList = document.getElementById('equip-char-list'); cList.innerHTML = "";
        Game.party.forEach(c => {
            let el = document.createElement('div');
            el.className = `list-item ${this.equipChar===c?'selected':''}`;
            el.innerHTML = `<div>${c.name}</div><div style="font-size:10px;">${c.job.name}</div>`;
            el.onclick = () => { this.equipChar = c; this.renderInv(); };
            cList.appendChild(el);
        });
        const iList = document.getElementById('inv-list'); iList.innerHTML = "";
        const head = document.getElementById('inv-header');
        if(!this.equipChar) { iList.innerHTML="ã‚­ãƒ£ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„"; return; }
        
        let eqHtml = "";
        for(let slot in this.equipChar.equipment) {
            let item = this.equipChar.equipment[slot];
            eqHtml += `<div style="font-size:11px; margin-bottom:2px;"><span style="color:#666; display:inline-block; width:60px;">${slot.substr(0,4)}:</span>${item ? `<span class="rar-${item.rarity}">${item.name}</span> <button style="font-size:9px;" onclick="UI.doUnequip('${slot}')">å¤–ã™</button>` : 'ç©º'}</div>`;
        }
        head.innerHTML = eqHtml;
        if(Game.inventory.length===0) iList.innerHTML = "ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“";
        Game.inventory.forEach((item, idx) => {
            if (!item) return; 
            
            const check = this.equipChar.canEquip(item);
            const err = check.ok ? "" : `<span class="err-msg">${check.reason}</span>`;
            const cls = check.ok ? "" : "disabled";

            let el = document.createElement('div');
            el.className = `list-item ${cls}`;
            let stats = Object.keys(item.stats).map(k=>`${k}:${item.stats[k]}`).join(' ');
            el.innerHTML = `<div class="rar-${item.rarity}" style="font-weight:bold;">${item.name}</div><div style="font-size:10px; color:#888;">${item.type} [${item.slot}]</div><div style="font-size:10px;">${stats}</div>${err}`;
            if(check.ok) {
                el.onclick = () => { 
                    if(this.equipChar.equip(item)) {
                        Game.inventory.splice(idx,1); 
                        this.renderInv(); 
                        this.renderParty();
                        if(document.getElementById('modal-char-detail').style.display === 'flex') {
                            this.showCharDetail(this.equipChar);
                        }
                    }
                };
            }
            iList.appendChild(el);
        });
    },
    doUnequip(slot) { 
        this.equipChar.unequip(slot); 
        this.renderInv(); 
        this.renderParty();
        if(document.getElementById('modal-char-detail').style.display === 'flex') {
            this.showCharDetail(this.equipChar);
        }
    },

    showCharDetail(c) {
        const s = c.totalStats;
        const b = c.battleStats;
        const elems = c.elements.map(e => `<span class="elem-icon el-${e}"></span> ${ELEMENTS[e].name}`).join(', ') || "ãªã—";
        
        const openEquip = () => {
            document.getElementById('modal-char-detail').style.display='none';
            this.equipChar = c;
            this.openModal('modal-inv', this.renderInv);
        };
        window.openEquipFromDetail = openEquip;

        let equipRows = "";
        for(let slot in c.equipment) {
            let item = c.equipment[slot];
            let name = item ? `<span class="rar-${item.rarity}">${item.name}</span>` : "è£…å‚™ãªã—";
            let stats = item ? Object.keys(item.stats).map(k=>`${k.toUpperCase()}:${item.stats[k]}`).join(' ') : "";
            equipRows += `
            <div class="detail-eq-row">
                <span style="color:#888; font-size:11px; width:80px;">${slot}</span>
                <div>${name} <span style="font-size:10px; color:#aaa; margin-left:5px;">${stats}</span></div>
            </div>`;
        }

        let skills = c.skills.length ? c.skills.map(sk => `<span class="skill-tag" style="font-size:12px; padding:3px 6px;">${sk}</span>`).join(' ') : "ãªã—";

        const content = `
            <div class="detail-header">
                <div class="detail-title">
                    <h2>${c.name}</h2>
                    <div class="detail-meta">${c.job.name} (${c.job.atkType==="mag"?"é­”æ³•":"ç‰©ç†"}) Lv.${c.level} | ${c.personality} | ä¸–ä»£:${c.generation}</div>
                </div>
            </div>
            <div class="detail-sections">
                <div>
                    <h4 style="color:#888; border-bottom:1px solid #333;">åŸºç¤ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
                    <div class="detail-row"><span class="detail-label">HP</span> <span>${c.hp} / ${s.hp}</span></div>
                    <div class="detail-row"><span class="detail-label">STR (è…•åŠ›)</span> <span>${s.atk}</span></div>
                    <div class="detail-row"><span class="detail-label">VIT (è€ä¹…)</span> <span>${s.def}</span></div>
                    <div class="detail-row"><span class="detail-label">MAG (é­”åŠ›)</span> <span>${s.mag}</span></div>
                    <div class="detail-row"><span class="detail-label">INT (çŸ¥åŠ›)</span> <span>${s.int}</span></div>
                    <div class="detail-row"><span class="detail-label">AGI (ç´ æ—©)</span> <span>${s.agi}</span></div>
                    <div class="detail-row"><span class="detail-label">LUC (é‹)</span> <span>${s.luc}</span></div>
                    <div class="detail-row"><span class="detail-label">å±æ€§</span> <span>${elems}</span></div>
                    <br>
                    <h4 style="color:#888; border-bottom:1px solid #333;">æˆ¦é—˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h4>
                    <div class="detail-row"><span class="detail-label">ç‰©ç†æ”»æ’ƒåŠ›</span> <span>${b.pAtk}</span></div>
                    <div class="detail-row"><span class="detail-label">é­”æ³•æ”»æ’ƒåŠ›</span> <span>${b.mAtk}</span></div>
                    <div class="detail-row"><span class="detail-label">é˜²å¾¡åŠ›</span> <span>${b.def}</span></div>
                    <div class="detail-row"><span class="detail-label">å‘½ä¸­ç‡</span> <span>${Math.floor(b.hit)}</span></div>
                    <div class="detail-row"><span class="detail-label">ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«</span> <span>${Math.floor(b.crit)}%</span></div>
                </div>
                <div>
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #444;">
                        <h4>è£…å‚™</h4>
                        <button onclick="openEquipFromDetail()" style="padding:2px 8px; font-size:10px;">å¤‰æ›´</button>
                    </div>
                    ${equipRows}
                    <h4 style="margin:15px 0 10px 0; border-bottom:1px solid #444;">ç¿’å¾—ã‚¹ã‚­ãƒ«</h4>
                    <div style="line-height:1.8;">${skills}</div>
                </div>
            </div>
        `;
        document.getElementById('detail-content').innerHTML = content;
        this.openModal('modal-char-detail');
    }
};

window.onload = () => Game.init();

</script>
</body>
</html>